# Tolerant Inline Math

An Obsidian plugin that renders inline LaTeX formulas with spaces inside the dollar signs — a format that Obsidian normally ignores.

```
$ \frac{a}{b} $   →   renders correctly as a math formula ✅
```

---

## The Problem

Obsidian requires that inline math delimiters have **no spaces** immediately inside the dollar signs:

| Format | Obsidian native behavior |
|--------|--------------------------|
| `$formula$` | ✅ Renders correctly |
| `$ formula $` | ❌ Treated as plain text |
| `$ \frac{a}{b} $` | ❌ Treated as plain text |

This is an intentional design decision to avoid misidentifying price strings like `"the cost is $2.50 and $3.00"` as math formulas.

However, native LaTeX is indifferent to spaces inside dollar signs. Markdown notes generated by **OCR tools** and certain LaTeX writing habits commonly produce `$ formula $` style inline math. These notes cannot be fixed by bulk find-and-replace when new OCR output arrives continuously.

This plugin handles the rendering at the display layer — **without modifying any source files**.

---

## Installation

### Manual (current method)

1. Copy the `obsidian-tolerant-math/` folder (containing `manifest.json` and the compiled `main.js`) into your vault's `.obsidian/plugins/` directory
2. In Obsidian, go to **Settings → Community Plugins**, disable Safe Mode if prompted
3. Find **Tolerant Inline Math** in the plugin list and enable it

### Build from source

```bash
cd .obsidian/plugins/obsidian-tolerant-math
npm install
npm run build
```

After building, `main.js` will appear in the project directory. Reload the plugin in Obsidian to apply changes.

---

## Features

### Reading View

When switching to Reading View, the plugin scans the rendered DOM, finds `$ formula $` patterns in text nodes, and replaces them with properly rendered MathJax elements using Obsidian's built-in math API.

**Left untouched:**
- `$formula$` — no spaces, already handled by Obsidian
- `$$...$$` — block math, already handled by Obsidian
- Content inside code blocks and inline code spans
- Price-like text such as `$5` or `$2.50` (only a single `$`, no closing match)

### Live Preview

In Live Preview mode, formulas are rendered inline as you write:

- **Cursor inside a formula** — the decoration is removed and the raw source text `$ formula $` is shown for editing
- **Cursor outside a formula** — the formula is displayed as rendered math
- Only formulas within the **current viewport** are processed (performance optimization)

---

## Usage Example

Write the following in any note and switch to Reading View:

```markdown
## Inline Math Test

With spaces: $ E = mc^2 $

Fraction: $ \frac{a}{b} $

Greek letters: $ \alpha + \beta = \gamma $

Multiple on one line: Let $ x > 0 $ and $ y > 0 $, then $ x + y > 0 $.

These are NOT affected:
- Standard format (handled by Obsidian): $E = mc^2$
- Block math (handled by Obsidian): $$E = mc^2$$
- Inside a code span: `$ formula $`
- Price text: The price is $5 and $10.
```

---

## How It Works

### Matching Regex

```
/(?<!\$)\$[ \t]+([^\$\n]+?)[ \t]+\$(?!\$)/g
```

| Part | Purpose |
|------|---------|
| `(?<!\$)` | Negative lookbehind — ensures the opening `$` is not part of `$$` |
| `[ \t]+` | Requires at least one horizontal whitespace inside the opening `$` |
| `([^\$\n]+?)` | Lazy capture of formula content — no newlines, no `$` |
| `[ \t]+` | Requires at least one horizontal whitespace before the closing `$` |
| `(?!\$)` | Negative lookahead — ensures the closing `$` is not part of `$$` |

Using `[ \t]` instead of `\s` prevents cross-line matching (inline math cannot span lines).
Using a lazy quantifier (`+?`) correctly handles multiple formulas on the same line.

### Reading View Pipeline

`registerMarkdownPostProcessor` → `TreeWalker` traverses text nodes (skipping `<code>`, `<pre>`, `<math>`, `.math` elements) → matched nodes are split into a `DocumentFragment` with rendered math elements inserted → `finishRenderMath()` is called once per batch to flush the MathJax render queue.

Text nodes are collected before processing begins to avoid invalidating the walker while modifying the DOM.

### Live Preview Pipeline

A CodeMirror 6 `ViewPlugin` scans `visibleRanges` on every document change, viewport change, or cursor move. Matching ranges are decorated with `Decoration.replace` backed by a `WidgetType` that calls `renderMath()` in `toDOM()`. If any cursor selection overlaps a match, the decoration is skipped for that range, exposing the raw source text.

### Rendering API

Obsidian's built-in `renderMath()` and `finishRenderMath()` are used exclusively. No external MathJax or KaTeX is bundled. This guarantees that rendered formulas are visually identical to Obsidian's native math output.

---

## Known Limitations

- **Space requirement**: Only `$ formula $` (spaces on **both** sides) is matched. Asymmetric cases like `$formula $` are not handled. OCR output is typically symmetric, making this a non-issue in practice.
- **Dollar sign inside formula**: Content containing a literal `$` (e.g., `$ \$100 $`) is not matched — this format is inherently ambiguous and is intentionally left unhandled.
- **No cross-line formulas**: Inline math cannot span multiple lines, consistent with Obsidian's native behavior.
- **Source Mode**: No rendering is applied in Source (raw text) mode, which is the expected behavior.

---

## Development

### Project Structure

```
obsidian-tolerant-math/
├── src/
│   └── main.ts          # All plugin logic (single file)
├── manifest.json        # Plugin metadata
├── package.json
├── tsconfig.json
├── esbuild.config.mjs   # Build configuration
└── main.js              # Compiled output (generated by build)
```

### Dev Mode (watch)

```bash
npm run dev
```

Starts esbuild in watch mode. Any change to `src/main.ts` triggers an automatic rebuild. Pair with the [Hot Reload](https://github.com/pjeby/hot-reload) community plugin to avoid restarting Obsidian.

### Production Build

```bash
npm run build
```

Produces a minified `main.js` without source maps.

### Dependency Notes

All `@codemirror/*` packages are `devDependencies` — they provide TypeScript type definitions at build time only. At runtime, Obsidian supplies these modules itself. The esbuild config marks them as `external` so they are not bundled into `main.js`, which prevents version conflicts with Obsidian's internal CM6 instance.

---

## Compatibility

- **Minimum Obsidian version**: 1.3.0
- **Desktop / Mobile**: Both supported (`isDesktopOnly: false`)
- **Co-existence with other math plugins**:
  - *No more flickering inline math* — complementary, no conflicts
  - *Latex Suite* — complementary, no conflicts
